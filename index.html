<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SurgStudy | æœ¯å½±å­¦ä¹ æ‰“å¡</title>
    <style>
        :root {
            --primary: #003366; /* åŒ»ç–—æ·±è“ */
            --primary-light: #e6f0ff;
            --accent: #20c997;  /* æˆåŠŸç»¿ */
            --text: #333;
            --text-light: #888;
            --bg: #f8f9fa;
            --white: #ffffff;
            --border: #eee;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            padding-bottom: 80px; /* FAB space */
        }

        /* å¤´éƒ¨ç»Ÿè®¡å¡ç‰‡ */
        .header-card {
            background: linear-gradient(135deg, var(--primary) 0%, #0056b3 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 51, 102, 0.2);
        }
        .header-title { font-size: 18px; font-weight: 600; margin-bottom: 10px; opacity: 0.9; }
        .stats-row { display: flex; justify-content: space-between; }
        .stat-item { text-align: center; }
        .stat-num { font-size: 24px; font-weight: 700; display: block; }
        .stat-label { font-size: 12px; opacity: 0.8; }

        /* æ—¥å†åŒºåŸŸ */
        .calendar-container {
            background: var(--white);
            border-radius: 16px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-weight: bold;
            color: var(--primary);
        }
        .btn-month { background: none; border: none; color: var(--primary); font-size: 18px; cursor: pointer; padding: 0 10px; }
        
        .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; color: var(--text-light); margin-bottom: 10px; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        
        .day {
            aspect-ratio: 1/1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            transition: background 0.2s;
        }
        .day:active { background: #f0f0f0; }
        .day.today { color: var(--primary); font-weight: bold; border: 1px solid var(--primary); }
        .day.selected { background-color: var(--primary); color: white; }
        .day.has-log::after {
            content: '';
            width: 5px; height: 5px;
            background-color: var(--accent);
            border-radius: 50%;
            position: absolute;
            bottom: 4px;
        }

        /* è®°å½•åˆ—è¡¨ */
        .log-list-title { font-size: 14px; color: var(--text-light); margin-bottom: 10px; font-weight: 600; }
        .log-card {
            background: var(--white);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .log-info h4 { margin: 0 0 5px 0; font-size: 16px; color: #333; }
        .log-info p { margin: 0; font-size: 13px; color: #666; }
        .log-tag { background: var(--primary-light); color: var(--primary); padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-right: 5px; }

        /* æ‚¬æµ®æŒ‰é’® (FAB) */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 4px 15px rgba(0, 51, 102, 0.4);
            cursor: pointer;
            z-index: 100;
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: flex-end; /* åº•éƒ¨å¼¹å‡º */
        }
        .modal-content {
            background: white;
            width: 100%;
            padding: 25px 20px;
            border-radius: 20px 20px 0 0;
            box-sizing: border-box;
            animation: slideUp 0.3s;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 14px; color: #666; }
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .btn-block {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
        }

        /* ç»Ÿè®¡èƒ¶å›Š */
        .top-stats {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 12px;
        }
        .capsule {
            display: inline-block;
            background: #f0f2f5;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            color: #555;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .capsule strong { color: var(--primary); }

    </style>
</head>
<body>

<div class="header-card">
    <div class="header-title">ğŸ‘‹ Dr. å­¦ä¹ ç»Ÿè®¡</div>
    <div class="stats-row">
        <div class="stat-item">
            <span class="stat-num" id="total-count">0</span>
            <span class="stat-label">ç´¯è®¡æ‰“å¡ (ä¸ª)</span>
        </div>
        <div class="stat-item">
            <span class="stat-num" id="month-count">0</span>
            <span class="stat-label">æœ¬æœˆå­¦ä¹  (ä¸ª)</span>
        </div>
        <div class="stat-item">
            <span class="stat-num" id="top-expert">-</span>
            <span class="stat-label">æœ€çˆ±ä¸“å®¶</span>
        </div>
    </div>
</div>

<div class="calendar-container">
    <div class="calendar-header">
        <button class="btn-month" onclick="changeMonth(-1)">â€¹</button>
        <span id="current-month-label">2023å¹´ 10æœˆ</span>
        <button class="btn-month" onclick="changeMonth(1)">â€º</button>
    </div>
    <div class="weekdays">
        <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
    </div>
    <div class="days-grid" id="days-grid">
        </div>
</div>

<div>
    <div class="log-list-title" id="selected-date-title">ä»Šæ—¥è®°å½•</div>
    <div id="log-list-container">
        </div>
</div>

<div class="top-stats">
    <div class="log-list-title">é«˜é¢‘æœ¯å¼ (Top Procedures)</div>
    <div id="top-procedures-list">
        </div>
</div>

<div class="fab" onclick="openModal()">+</div>

<div class="modal" id="add-modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color:var(--primary)">æ–°å¢å­¦ä¹ è®°å½•</h3>
        
        <div class="form-group">
            <label>æ—¥æœŸ</label>
            <input type="date" id="input-date" class="form-control">
        </div>

        <div class="form-group">
            <label>ä¸“å®¶å§“å (Surgeon)</label>
            <input type="text" id="input-expert" class="form-control" placeholder="ä¾‹å¦‚: Heald, éƒ‘æ°‘å, å‚…ä¼ åˆš" list="expert-suggestions">
            <datalist id="expert-suggestions">
                </datalist>
        </div>

        <div class="form-group">
            <label>æœ¯å¼/éƒ¨ä½ (Procedure)</label>
            <input type="text" id="input-procedure" class="form-control" placeholder="ä¾‹å¦‚: CME å³åŠ, ISR, TME" list="procedure-suggestions">
            <datalist id="procedure-suggestions">
                <option value="CME å³åŠç»“è‚ åˆ‡é™¤">
                <option value="è…¹è…”é•œ TME">
                <option value="TaTME">
                <option value="ISR (æ‹¬çº¦è‚Œé—´åˆ‡é™¤)">
                <option value="ELAPE">
                <option value="NOSES">
            </datalist>
        </div>

        <div class="form-group">
            <label>å¤‡æ³¨ (Key Learning Points)</label>
            <input type="text" id="input-note" class="form-control" placeholder="ä¾‹å¦‚: è¡€ç®¡æ ¹éƒ¨æ¸¸ç¦»æŠ€å·§...">
        </div>

        <button class="btn-block" onclick="saveLog()">æ‰“å¡ä¿å­˜</button>
        <div style="text-align:center; margin-top:15px; color:#999; font-size:14px;" onclick="closeModal()">å–æ¶ˆ</div>
    </div>
</div>

<script>
    // --- æ•°æ®å±‚ ---
    let logs = JSON.parse(localStorage.getItem('surgLogs')) || [];
    let currentDate = new Date(); // æ—¥å†å½“å‰æ˜¾ç¤ºçš„æœˆä»½
    let selectedDateStr = toDateStr(new Date()); // å½“å‰é€‰ä¸­çš„æ—¥æœŸå­—ç¬¦ä¸² yyyy-mm-dd

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        document.getElementById('input-date').value = selectedDateStr;
        renderCalendar();
        renderStats();
        renderLogsForDate(selectedDateStr);
    };

    // --- æ—¥å†æ ¸å¿ƒé€»è¾‘ ---
    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-11
        
        document.getElementById('current-month-label').innerText = `${year}å¹´ ${month + 1}æœˆ`;
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDayIndex = firstDay.getDay(); // 0(Sun) - 6(Sat)
        const totalDays = lastDay.getDate();

        const grid = document.getElementById('days-grid');
        grid.innerHTML = '';

        // å¡«å……ç©ºç™½
        for(let i=0; i<startDayIndex; i++) {
            let emptyDiv = document.createElement('div');
            grid.appendChild(emptyDiv);
        }

        // å¡«å……æ—¥æœŸ
        for(let i=1; i<=totalDays; i++) {
            let dayDiv = document.createElement('div');
            let dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            
            dayDiv.className = 'day';
            dayDiv.innerText = i;
            
            // æ ‡è®°ä»Šå¤©
            if(dateStr === toDateStr(new Date())) dayDiv.classList.add('today');
            // æ ‡è®°é€‰ä¸­
            if(dateStr === selectedDateStr) dayDiv.classList.add('selected');
            // æ ‡è®°æœ‰è®°å½•
            if(logs.some(log => log.date === dateStr)) dayDiv.classList.add('has-log');

            dayDiv.onclick = () => {
                selectedDateStr = dateStr;
                document.getElementById('input-date').value = dateStr;
                renderCalendar(); // é‡ç»˜ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
                renderLogsForDate(dateStr);
            };

            grid.appendChild(dayDiv);
        }
        
        updateStatsView();
    }

    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar();
    }

    // --- è®°å½•æ“ä½œé€»è¾‘ ---
    function saveLog() {
        const date = document.getElementById('input-date').value;
        const expert = document.getElementById('input-expert').value.trim();
        const procedure = document.getElementById('input-procedure').value.trim();
        const note = document.getElementById('input-note').value.trim();

        if(!date || !expert || !procedure) {
            alert("è¯·è‡³å°‘å¡«å†™æ—¥æœŸã€ä¸“å®¶å’Œæœ¯å¼");
            return;
        }

        const newLog = {
            id: Date.now(),
            date, expert, procedure, note
        };

        logs.push(newLog);
        logs.sort((a,b) => new Date(b.date) - new Date(a.date)); // æŒ‰æ—¥æœŸå€’åº
        localStorage.setItem('surgLogs', JSON.stringify(logs));

        closeModal();
        renderCalendar();
        renderLogsForDate(date);
        
        // æ¸…ç©ºè¡¨å•
        document.getElementById('input-expert').value = '';
        document.getElementById('input-procedure').value = '';
        document.getElementById('input-note').value = '';
        renderStats(); // æ›´æ–°ç»Ÿè®¡
    }

    function deleteLog(id) {
        if(confirm("ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) {
            logs = logs.filter(l => l.id !== id);
            localStorage.setItem('surgLogs', JSON.stringify(logs));
            renderCalendar();
            renderLogsForDate(selectedDateStr);
            renderStats();
        }
    }

    function renderLogsForDate(dateStr) {
        document.getElementById('selected-date-title').innerText = `${dateStr} å­¦ä¹ è®°å½•`;
        const container = document.getElementById('log-list-container');
        container.innerHTML = '';

        const daysLogs = logs.filter(l => l.date === dateStr);

        if(daysLogs.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#999; padding:20px; font-size:13px;">ç‚¹å‡» + å·æ·»åŠ ä»Šæ—¥å­¦ä¹ </div>';
            return;
        }

        daysLogs.forEach(log => {
            const card = document.createElement('div');
            card.className = 'log-card';
            card.innerHTML = `
                <div class="log-info">
                    <h4>${log.procedure}</h4>
                    <p>
                        <span class="log-tag">ğŸ‘¨â€âš•ï¸ ${log.expert}</span>
                        ${log.note ? '<span>ğŸ“ ' + log.note + '</span>' : ''}
                    </p>
                </div>
                <div style="color:#dc3545; font-size:18px; cursor:pointer;" onclick="deleteLog(${log.id})">Ã—</div>
            `;
            container.appendChild(card);
        });
    }

    // --- ç»Ÿè®¡é€»è¾‘ ---
    function renderStats() {
        // 1. æ€»æ•°
        document.getElementById('total-count').innerText = logs.length;

        // 2. ä¸“å®¶æ’å
        const expertCounts = {};
        const procCounts = {};
        logs.forEach(l => {
            expertCounts[l.expert] = (expertCounts[l.expert] || 0) + 1;
            procCounts[l.procedure] = (procCounts[l.procedure] || 0) + 1;
        });

        const sortedExperts = Object.entries(expertCounts).sort((a,b) => b[1] - a[1]);
        const sortedProcs = Object.entries(procCounts).sort((a,b) => b[1] - a[1]);

        document.getElementById('top-expert').innerText = sortedExperts.length > 0 ? sortedExperts[0][0] : '-';

        // 3. é«˜é¢‘æœ¯å¼å±•ç¤º
        const procContainer = document.getElementById('top-procedures-list');
        procContainer.innerHTML = '';
        sortedProcs.slice(0, 5).forEach(item => { // åªæ˜¾ç¤ºå‰5
            procContainer.innerHTML += `<div class="capsule">${item[0]} <strong>${item[1]}</strong></div>`;
        });
    }

    function updateStatsView() {
        // æœ¬æœˆç»Ÿè®¡
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth() + 1;
        const monthPrefix = `${year}-${String(month).padStart(2,'0')}`;
        const monthCount = logs.filter(l => l.date.startsWith(monthPrefix)).length;
        document.getElementById('month-count').innerText = monthCount;
    }

    // --- è¾…åŠ© ---
    function toDateStr(dateObj) {
        return dateObj.toISOString().split('T')[0];
    }
    function openModal() { document.getElementById('add-modal').style.display = 'flex'; }
    function closeModal() { document.getElementById('add-modal').style.display = 'none'; }

</script>

</body>
</html>